name: security

on:
  workflow_dispatch:
    inputs:
      repository:
        description: 'Repository to scan (owner/repo name only)'
        required: true
        default: 'SCA'
      ref:
        description: 'Branch to scan'
        required: true
        default: 'main'

permissions:
  contents: read
  security-events: write

env:
  TRIVY_SEVERITY: "HIGH,CRITICAL,MEDIUM"
  TRIVY_IGNORE_UNFIXED: "false"

jobs:
  trivy_gate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: 'ngdyquan213/${{ github.event.inputs.repository }}'
          token: ${{ secrets.TEST_CI_CD }}   # ðŸ‘‰ PAT cÃ³ security_events
          ref: ${{ github.event.inputs.ref }}

      - name: Generate SARIF (FS)
        run: |
          trivy fs . \
            --format sarif \
            --output trivy-results.sarif \
            --severity "${{ env.TRIVY_SEVERITY }}" \
            --ignore-unfixed="${{ env.TRIVY_IGNORE_UNFIXED }}" \
            --exit-code 0

      - name: Upload SARIF to Repo B
        run: |
          SARIF_CONTENT=$(base64 -w0 trivy-results.sarif)

          JSON_PAYLOAD=$(jq -n \
            --arg sarif "$SARIF_CONTENT" \
            --arg sha "0000000000000000000000000000000000000000" \
            --arg ref "refs/heads/${{ github.event.inputs.ref }}" \
            '{ commit_sha: $sha, ref: $ref, sarif: $sarif }')

          curl -X POST \
            -H "Authorization: token ${{ secrets.REPOB_PAT }}" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            "https://api.github.com/repos/ngdyquan213/${{ github.event.inputs.repository }}/code-scanning/sarifs"

