name: security-gate-trivy

on:
  workflow_dispatch:
    inputs:
      repository:
        description: 'Repository to scan (owner/repo name only)'
        required: true
        default: 'SCA'
      ref:
        description: 'Branch or tag to scan'
        required: true
        type: choice
        options:
          - main
          - master
        default: 'main'
      tags:
        description: 'Tags to assign in Dependency-Track (comma-separated)'
        required: false
        default: ''

permissions:
  actions: write
  contents: write
  security-events: write

env:
  TRIVY_SEVERITY: "HIGH,CRITICAL,MEDIUM"
  TRIVY_IGNORE_UNFIXED: "false"
  DT_PROTO: http
  DT_HOST: ${{ secrets.TEST_HOSTNAME }}
  DT_PORT: ${{ secrets.TEST_PORT }}
  DT_API_KEY: ${{ secrets.TEST_API_KEY }}

concurrency:
  group: security-${{ github.event.inputs.repository }}-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  trivy_gate:
    name: Trivy Gate (fail-fast)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: 'ngdyquan213/${{ github.event.inputs.repository }}'
          token: ${{ secrets.TEST_CI_CD }}  
          ref: '${{ github.event.inputs.ref }}'
          persist-credentials: false

      - name: Generate SARIF (FS)
        uses: aquasecurity/trivy-action@7b7aa264d83dc58691451798b4d117d53d21edfe
        with:
          scan-type: 'fs'          
          scan-ref: '.'
          format: 'template'
          template: '@/contrib/sarif.tpl'
          output: 'trivy-results.sarif'  
          vuln-type: 'library'
          severity: ${{ env.TRIVY_SEVERITY }}
          ignore-unfixed: ${{ env.TRIVY_IGNORE_UNFIXED }}
          exit-code: '0'
          hide-progress: 'false'

      - name: Upload SARIF to Repo B
        run: |
          SARIF_CONTENT=$(base64 -w0 trivy-results.sarif)

          JSON_PAYLOAD=$(jq -n \
            --arg sarif "$SARIF_CONTENT" \
            --arg sha "${GITHUB_SHA}" \
            --arg ref "refs/heads/${GITHUB_REF_NAME}" \
            '{ commit_sha: $sha, ref: $ref, sarif: $sarif }')

          curl -X POST \
            -H "Authorization: token ${{ secrets.TEST_CI_CD }}" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            "https://api.github.com/repos/ngdyquan213/${{ github.event.inputs.repository }}/code-scanning/sarifs"

          
      # - name: Upload SARIF to Repo B
      #   run: |
      #     curl -X POST \
      #       -H "Authorization: token ${{ secrets.TEST_CI_CD }}" \
      #       -H "Content-Type: application/json" \
      #       -d @"trivy-results.sarif" \
      #       https://api.github.com/repos/ngdyquan213/${{ github.event.inputs.repository }}/code-scanning/sarifs

      - name: Trivy FS scan (fail on HIGH/CRITICAL)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: ${{ env.TRIVY_SEVERITY }}
          ignore-unfixed: ${{ env.TRIVY_IGNORE_UNFIXED }}
          exit-code: '1'
          hide-progress: 'true'

