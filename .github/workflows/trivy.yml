name: security-gate-trivy

on:
  workflow_dispatch:
    inputs:
      repository:
        description: 'Repository to scan (owner/repo name only)'
        required: true
        default: 'security-cicd'
      version:
        description: 'Trivy Action version to use'
        required: false
        default: '0.28.0'

permissions:
  actions: read
  contents: read
  security-events: write

env:
  TRIVY_SEVERITY: "HIGH,CRITICAL"
  TRIVY_IGNORE_UNFIXED: "false"

concurrency:
  group: security-${{ github.event.inputs.repository }}-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  trivy_gate:
    name: Trivy Gate (fail-fast)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: 'ngdyquan213/${{ github.event.inputs.repository }}'
          token: ${{ secrets.TEST_CI_CD }}   # PAT có quyền read repo mục tiêu
          ref: 'main'
          persist-credentials: false

      - name: Generate SARIF (FS)
        uses: aquasecurity/trivy-action@7b7aa264d83dc58691451798b4d117d53d21edfe
        with:
          scan-type: 'fs'          
          scan-ref: '.'
          format: 'template'
          template: '@/contrib/sarif.tpl'
          output: 'trivy-results.sarif'  
          vuln-type: 'library'
          severity: ${{ env.TRIVY_SEVERITY }}
          ignore-unfixed: ${{ env.TRIVY_IGNORE_UNFIXED }}
          exit-code: '0'
          hide-progress: 'true'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Trivy FS scan (fail on HIGH/CRITICAL)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: ${{ env.TRIVY_SEVERITY }}
          ignore-unfixed: ${{ env.TRIVY_IGNORE_UNFIXED }}
          exit-code: '1'
          hide-progress: 'true'

  trivy_report:   
    name: Trivy Report (SARIF & SBOM)
    runs-on: ubuntu-latest   # hoặc prod-runner-set nếu đã sẵn
    needs: trivy_gate
    if: always()
    permissions:
      contents: read
      security-events: write
      actions: read
    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: 'ngdyquan213/${{ github.event.inputs.repository }}'
          token: ${{ secrets.TEST_CI_CD}}
          ref: 'main'

      - name: Generate CycloneDX SBOM
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'cyclonedx'
          output: 'sbom.json'

      - name: Capture target SHA
        id: sha
        run: echo "TARGET_SHA=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Upload SBOM to Dependency-Track
        uses: DependencyTrack/gh-upload-sbom@v3
        with:
          protocol: 'http'
          serverHostname: ${{ secrets.TEST_HOSTNAME }}
          port: ${{ secrets.TEST_PORT }}
          apiKey: ${{ secrets.TEST_API_KEY }}
          projectName: '${{ github.event.inputs.repository }}'
          projectVersion: 'v${{ github.run_number }}'
          bomFilename: '${{ github.workspace }}/sbom.json'
          autoCreate: true