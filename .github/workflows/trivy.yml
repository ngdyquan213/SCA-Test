name: security-gate-trivy

on:
  workflow_dispatch:
    inputs:
      repository:
        description: 'Repository to scan (owner/repo name only)'
        required: true
        default: 'HotelBooking'
      ref:
        description: 'Branch or tag to scan'
        required: true
        type: choice
        options:
          - main
          - master
        default: 'master'
      tags:
        description: 'Tags to assign in Dependency-Track (comma-separated)'
        required: false
        default: ''

permissions:
  actions: read
  contents: read
  security-events: write

env:
  TRIVY_SEVERITY: "HIGH,CRITICAL"
  TRIVY_IGNORE_UNFIXED: "false"
  DT_PROTO: http
  DT_HOST: ${{ secrets.TEST_HOSTNAME }}
  DT_PORT: ${{ secrets.TEST_PORT }}
  DT_API_KEY: ${{ secrets.TEST_API_KEY }}

concurrency:
  group: security-${{ github.event.inputs.repository }}-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  trivy_gate:
    name: Trivy Gate (fail-fast)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: 'ngdyquan213/${{ github.event.inputs.repository }}'
          token: ${{ secrets.TEST_CI_CD }}  
          ref: '${{ github.event.inputs.ref }}'
          persist-credentials: false

      - name: Generate SARIF (FS)
        uses: aquasecurity/trivy-action@7b7aa264d83dc58691451798b4d117d53d21edfe
        with:
          scan-type: 'fs'          
          scan-ref: '.'
          image-ref: '.'
          format: 'template'
          template: '@/contrib/sarif.tpl'
          output: 'trivy-results.sarif'  
          vuln-type: 'library'
          severity: ${{ env.TRIVY_SEVERITY }}
          ignore-unfixed: ${{ env.TRIVY_IGNORE_UNFIXED }}
          exit-code: '0'
          hide-progress: 'true'

      # - name: Upload SARIF to target repo (REST)
      #   shell: bash
      #   env:
      #     TARGET_REPO: ${{ github.event.inputs.repository }} # owner/repo
      #     TARGET_REF: ${{ github.event.inputs.ref }}         # main/master (branch)
      #     GH_PAT: ${{ secrets.TEST_CI_CD }}             # PAT with repo + security_events
      #   run: |
      #     set -euo pipefail

      #     # L·∫•y sha th·∫≠t c·ªßa repo m·ª•c ti√™u v·ª´a checkout
      #     TARGET_SHA=$(git rev-parse HEAD)
      #     echo "Target sha: $TARGET_SHA; ref: $TARGET_REF; repo: $TARGET_REPO"

      #     # Chu·∫©n b·ªã payload: sarif ph·∫£i gzip + base64 kh√¥ng xu·ªëng d√≤ng
      #     SARIF_B64=$(gzip -c trivy-results.sarif | base64 -w 0)

      #     # GitHub API ƒë√≤i format ref l√† refs/heads/<branch> ho·∫∑c refs/tags/<tag>
      #     if [[ "$TARGET_REF" == refs/* ]]; then
      #       REF_FULL="$TARGET_REF"
      #     else
      #       REF_FULL="refs/heads/$TARGET_REF"
      #     fi

      #     OWNER="${TARGET_REPO%%/*}"
      #     REPO="${TARGET_REPO##*/}"

      #     JSON_PAYLOAD=$(jq -n \
      #       --arg sarif "$SARIF_B64" \
      #       --arg sha "$TARGET_SHA" \
      #       --arg ref "$REF_FULL" \
      #       --arg tool "trivy" \
      #       '{ sarif: $sarif, commit_sha: $sha, ref: $ref, tool_name: $tool }')

      #     echo "Uploading SARIF to https://api.github.com/repos/$OWNER/$REPO/code-scanning/sarifs"
      #     curl -sS -X POST \
      #       -H "Authorization: Bearer $GH_PAT" \
      #       -H "Accept: application/vnd.github+json" \
      #       -H "X-GitHub-Api-Version: 2022-11-28" \
      #       "https://api.github.com/repos/$OWNER/$REPO/code-scanning/sarifs" \
      #       -d "$JSON_PAYLOAD" \
      #       | jq .

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Trivy FS scan (fail on HIGH/CRITICAL)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: ${{ env.TRIVY_SEVERITY }}
          ignore-unfixed: ${{ env.TRIVY_IGNORE_UNFIXED }}
          exit-code: '1'
          hide-progress: 'true'

  trivy_report:   
    name: Trivy Report (SARIF & SBOM)
    runs-on: ubuntu-latest   # ho·∫∑c prod-runner-set n·∫øu ƒë√£ s·∫µn
    needs: trivy_gate
    if: always()
    permissions:
      contents: read
      security-events: write
      actions: read
    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: 'ngdyquan213/${{ github.event.inputs.repository }}'
          token: ${{ secrets.TEST_CI_CD}}
          ref: '${{ github.event.inputs.ref }}'

      - name: Generate CycloneDX SBOM
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'cyclonedx'
          output: 'sbom.json'

      - name: Resolve next projectVersion (v1, v2, v3, ...)
        id: ver
        shell: bash
        env:
          PROJECT_NAME: ${{ github.event.inputs.repository }}
        run: |
          set -euo pipefail
          BASE="${DT_PROTO}://${DT_HOST}:${DT_PORT}"

          # URL-encode project name an to√†n
          NAME_ENC=$(jq -rn --arg x "$PROJECT_NAME" '$x|@uri')

          echo "üîç Finding next version for project: $PROJECT_NAME"
          # TƒÉng d·∫ßn t·ª´ v1 ƒë·∫øn khi g·∫∑p version ch∆∞a t·ªìn t·∫°i
          n=1
          max=1000  # guard tr√°nh v√≤ng l·∫∑p v√¥ h·∫°n n·∫øu c√≥ s·ª± c·ªë
          while (( n <= max )); do
            ver="v${n}"
            code=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "X-Api-Key: ${DT_API_KEY}" \
              "${BASE}/api/v1/project/lookup?name=${NAME_ENC}&version=${ver}" || true)
            if [[ "$code" == "200" ]]; then
              # version ƒë√£ t·ªìn t·∫°i -> th·ª≠ ti·∫øp
              ((n++))
            else
              # g·∫∑p version ch∆∞a t·ªìn t·∫°i -> d√πng n√≥
              echo "‚úÖ Using new version: ${ver}"
              echo "version=${ver}" >> "$GITHUB_OUTPUT"
              break
            fi
          done        

      - name: Upload SBOM to Dependency-Track
        uses: DependencyTrack/gh-upload-sbom@v3
        with:
          protocol: 'http'
          serverhostname: ${{ secrets.TEST_HOSTNAME }}
          port: ${{ secrets.TEST_PORT }}
          apikey: ${{ secrets.TEST_API_KEY }}
          projectname: ${{ github.event.inputs.repository }}
          projectversion: ${{ steps.ver.outputs.version }}
          projecttags: ${{ github.event.inputs.tags }}
          bomfilename: ${{ github.workspace }}/sbom.json
          autocreate: true